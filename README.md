# 🚀 업비트 모멘텀 트레이딩 봇 v3.3

"달리는 말에 올라타되, **초반에 올라타는**" 다중 타임프레임 전략을 구현한 자동 코인 트레이딩 봇입니다.

## 📋 전략 개요

### 핵심 철학
- **다중 타임프레임 분석 (MTF)**: 1분봉, 5분봉, 15분봉을 종합 분석하여 진입 타이밍 결정
- **상승 초기 진입**: 고점 추격을 방지하고 상승 초기~중반에만 진입
- **전문가 관점 분석**: RSI, 피로도, 매수/매도 세력 비율, 호가창 분석으로 종합 판단
- **스마트 데이터 관리**: 로컬 캐싱으로 빠른 재실행 및 API 효율화
- **장기 추세 순응**: 일봉/4시간봉 하락 시 진입을 원천 차단하여 리스크 제거
- **동적 청산**: 트레일링 스탑으로 수익 보호, 동적 손절로 손실 최소화

---

## 🆕 v3.3 핵심 개선사항: 스마트 데이터 & 강력한 필터링

### 1. 📉 장기 하락장 필터 (Hard Downtrend Filter)
단기 급등(Short Squeeze)에 속지 않기 위해 장기 추세가 하락인 경우 **무조건 진입을 차단**합니다.

| 분류           | 기준            | 동작                                   |
| -------------- | --------------- | -------------------------------------- |
| **3일 추세**   | -2.0% 이하 하락 | **🚫 진입 차단** (Dead Cat Bounce 방지) |
| **4시간 추세** | -1.5% 이하 하락 | **🚫 진입 차단** (하락 추세 역행 방지)  |

### 2. ⚡ 스마트 데이터 로딩 (Smart Data Loading)
- **로컬 캐싱**: `data/` 디렉토리에 캔들 데이터를 JSON으로 저장하여 영구 보관
- **고속 초기화**: 재시작 시 부족한 데이터(Gap)만 API로 요청 (초기 로딩 3초 이내)
- **API 절약**: 불필요한 전체 데이터 요청을 제거하여 API 리밋 방지

### 3. 🛡️ 진입 장벽 강화 & 중복 주문 방지
- **진입 모멘텀 상향**: 1.2% → **1.5%** (더 확실한 상승만 진입)
- **최소 강도 상향**: 종합 점수 60점 → **75점** (확실한 자리만 진입)
- **중복 주문 방지 (Order Lock)**: 비동기 환경에서의 중복 체결(따닥) 원천 차단

---

## 🆕 v3.1 핵심 개선사항: 손실 최소화 & 수익 보호

8시간 실거래 분석 결과에 기반한 전략 최적화입니다.

### 📉 동적 손절선 (Adaptive Stop Loss)

| 기능              | 기존    | v3.1                             |
| ----------------- | ------- | -------------------------------- |
| 손절선            | 고정 2% | **동적 1.8%~3.5%** (변동성 기반) |
| 손절 후 쿨다운    | 5분     | **10분**                         |
| 연속 손절 시      | -       | **20분 추가 대기**               |
| 1시간 내 3회 손절 | -       | **거래 중지**                    |

```
변동성 낮음 → 손절선 1.8% (타이트하게)
변동성 높음 → 손절선 3.5% (여유있게)
```

### 💰 최소 수익 보장 (Guaranteed Minimum Profit)

| 항목            | 기존   | v3.1                    |
| --------------- | ------ | ----------------------- |
| 트레일링 활성화 | +1.5%  | **+1.2%** (빨리 활성화) |
| 트레일링 거리   | 1.0%   | **0.8%** (타이트하게)   |
| 최소 수익 보장  | ❌ 없음 | **✅ 0.5% 보장**         |
| 목표 수익률     | 2%     | **2.5%**                |

```
┌─────────────────────────────────────────────────────────┐
│  트레일링 스탑 로직 (v3.1)                               │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  +1.2% 도달 → 🟢 트레일링 활성화                         │
│              └→ 최소 수익 보장선: 매입가 + 0.5%          │
│                                                         │
│  계속 상승 → 📈 고점 추적                               │
│              └→ 손절선: max(고점-0.8%, 매입가+0.5%)     │
│                                                         │
│  하락 시 → 🔔 손절선 도달하면 익절                       │
│           └→ 최소 0.5% 수익 보장!                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 🛡️ 재진입 방지 시스템

| 조건                  | 효과                         |
| --------------------- | ---------------------------- |
| 손절 직후 동일 가격대 | 2% 이상 하락해야 재진입 허용 |
| 연속 2회 손절         | 20분 추가 쿨다운             |
| 1시간 내 3회 손절     | 해당 종목 거래 중지          |

### 📊 진입 필터 강화

| 필터             | 기존 | v3.1             |
| ---------------- | ---- | ---------------- |
| 피로도 임계값    | 40   | **35**           |
| RSI 과매수       | 70   | **65**           |
| RSI 진입 차단    | -    | **75 이상 차단** |
| 매도 우위 차단   | 55%  | **50%**          |
| 필요 모멘텀 강도 | 70   | **75**           |

---

## 🔄 v3.0 핵심 개선사항: 다중 타임프레임 분석 (MTF)

### 문제점 분석 (기존 전략)
| 문제점              | 원인                  | 결과                       |
| ------------------- | --------------------- | -------------------------- |
| 고점 추격 매수      | 1분봉/초봉만 분석     | 상승 막바지에 진입 후 손절 |
| 낮은 승률 (20%)     | 피로도 높은 시점 진입 | 빈번한 stop_loss           |
| 동일 종목 반복 손실 | 하락 추세 무시        | 역추세 진입                |

### 해결책: 다중 타임프레임 필터

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📊 다중 타임프레임 분석 (Multi-Timeframe Analysis)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   15분봉 (중기 추세)          5분봉 (단기 추세)          1분봉+초봉 (진입)    │
│   ┌───────────────┐          ┌───────────────┐          ┌───────────────┐   │
│   │               │          │     상승      │          │               │   │
│   │   상승/횡보   │ ───────► │   초기/중반   │ ───────► │  모멘텀 감지  │   │
│   │    (확인)     │          │    (확인)     │          │    (진입!)    │   │
│   └───────────────┘          └───────────────┘          └───────────────┘   │
│         │                          │                          │             │
│         ▼                          ▼                          ▼             │
│   하락 시 → 차단            후반 시 → 차단             신호 없음 → 대기      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  🎯 핵심: "상승 초기"에만 진입 - 고점 추격 방지                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 상승 단계 판단 기준

| 단계                 | 5분봉 상승률 | 진입 여부     | 신호 강도 조정 |
| -------------------- | ------------ | ------------- | -------------- |
| 🟢 **초기 (early)**   | 0.2% ~ 1.0%  | ✅ 진입        | +20% 보너스    |
| 🟡 **중반 (mid)**     | 1.0% ~ 2.5%  | ✅ 진입 (신중) | -10%           |
| 🔴 **후반 (late)**    | 2.5% 이상    | ❌ 차단        | -              |
| ⚪ **중립 (neutral)** | 0.2% 미만    | ⚠️ 조건부      | 기본값         |

### 15분봉 추세 필터

| 추세             | 조건          | 결과                      |
| ---------------- | ------------- | ------------------------- |
| 📈 상승 (bullish) | +0.1% 이상    | 진입 허용 + 강도 +5       |
| ➖ 횡보 (neutral) | -0.1% ~ +0.1% | 진입 허용                 |
| 📉 하락 (bearish) | -0.1% 이하    | **진입 차단** (엄격 모드) |

---

## 🧠 전문가 관점 분석 시스템

단순한 가격 상승만 보고 진입하지 않고, 시장 심리와 수급을 종합적으로 분석합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 종합 시장 심리 분석 (실시간 WebSocket 기반)                   │
├─────────────────────────────────────────────────────────────────┤
│  1. RSI (상대강도지수)                                           │
│     ├── 70↑: 과매수 구간 → 진입 신중 / 80↑: 진입 차단           │
│     └── 30↓: 과매도 구간 → 반등 가능성 높음                      │
├─────────────────────────────────────────────────────────────────┤
│  2. 급등 피로도 (0-100)                                          │
│     ├── 5분간 급격한 상승률                                      │
│     ├── RSI 과매수 가중치                                        │
│     ├── 거래량 스파이크 후 급감 (모멘텀 소진)                    │
│     └── 매도 우위 전환 감지                                      │
│     → 40↑: 신중 접근 / 60↑: 조정 가능성 높음                    │
├─────────────────────────────────────────────────────────────────┤
│  3. 매수/매도 세력 분석                                          │
│     ├── 1분간 체결 데이터 실시간 집계                            │
│     ├── 매수체결(BID) vs 매도체결(ASK) 비율                      │
│     └── 65%↑ 매수: 강한 매수세 / 35%↓ 매수: 매도 압력            │
├─────────────────────────────────────────────────────────────────┤
│  4. 호가창 불균형 (-1 ~ +1)                                      │
│     ├── +0.3↑: 매수벽 우위 (지지력 강함)                        │
│     └── -0.3↓: 매도벽 우위 (저항 강함)                          │
├─────────────────────────────────────────────────────────────────┤
│  5. 변동성 분석                                                  │
│     └── 표준편차 기반 변동성이 2%↑이면 리스크 가중               │
└─────────────────────────────────────────────────────────────────┘
           ↓ 종합 점수 (0-100)
    🟢 Bullish (65↑)  🟡 Neutral (35-65)  🔴 Bearish (35↓)
```

---

## 🎯 진입 조건 (5단계 필터링)

```
1️⃣ 종합 심리 분석 → 부정적(bearish)이면 즉시 차단
2️⃣ 모멘텀 감지 → 분봉+초봉 결합 분석
3️⃣ MTF 필터 → 5분봉/15분봉 상승 단계 확인 ← 🆕 핵심
4️⃣ 피로도/과매수 필터링 → 조건 강화 또는 차단
5️⃣ 모멘텀 소진 체크 → 거래량 급감 시 차단
```

| 단계      | 조건                                        | 결과           |
| --------- | ------------------------------------------- | -------------- |
| 1단계     | 심리 점수 35점 미만                         | ❌ 진입 차단    |
| 2단계     | 모멘텀 신호 없음                            | ❌ 대기         |
| **3단계** | **5분봉 상승 후반(2.5%↑) 또는 15분봉 하락** | **❌ MTF 차단** |
| 4단계     | 피로도 40↑ 또는 RSI 70↑                     | 강도 70↑ 필요  |
| 5단계     | 모멘텀 소진                                 | ❌ 진입 보류    |
| 통과      | 모든 조건 충족                              | ✅ 진입 확정    |

---

## 📈 청산 전략 (트레일링 스탑 v3.1)

```
매수 후
    │
    ├── +1.2% 도달 → 🟢 트레일링 스탑 활성화
    │                    └→ 최소 수익 보장선 설정 (매입가 + 0.5%)
    │
    ├── +2.5% 도달 → 🎯 목표 수익률 도달
    │                    └→ 손절선을 최소 수익 보장선으로 상향
    │                    ↓
    │              계속 상승 추세 추적 (바로 익절하지 않음)
    │                    ↓
    └── 고점에서 -0.8% 하락 → 트레일링 스탑 발동 (익절, 최소 0.5% 보장)

💡 핵심: 트레일링 활성화 후에는 절대 손실이 발생하지 않음!
     최소 0.5% 수익 보장선 이하로 손절선이 내려가지 않음

손절: 동적 손절선 (변동성 기반 1.8%~3.5%)
시간제한: 6시간 보유 시 자동 청산
```

---

## 🛠 설치 및 실행

### 1. 환경 설정
```bash
# 가상환경 생성
python3 -m venv venv

# 가상환경 활성화
source venv/bin/activate

# 패키지 설치
pip install websockets aiohttp python-dotenv PyJWT requests redis
```

### 2. API 키 설정
`.env` 파일에 업비트 API 키가 설정되어 있어야 합니다:
```
UPBIT_ACCESS_KEY=your_access_key
UPBIT_SECRET_KEY=your_secret_key
```

### 3. 실행
```bash
# 방법 1: 직접 실행
./venv/bin/python momentum_trader.py

# 방법 2: 백그라운드 실행
nohup ./venv/bin/python momentum_trader.py > trading.log 2>&1 &

# 로그 실시간 확인
tail -f trading.log
```

---

## ⚙️ 파라미터 조정

`momentum_trader.py` 상단의 파라미터를 조정하여 전략을 커스터마이징할 수 있습니다.

### 투자 설정
| 파라미터           | 기본값    | 설명                |
| ------------------ | --------- | ------------------- |
| `MAX_INVESTMENT`   | 1,000,000 | 최대 투자금 (원)    |
| `MIN_ORDER_AMOUNT` | 5,000     | 최소 주문 금액      |
| `TRADING_FEE_RATE` | 0.0005    | 거래 수수료 (0.05%) |

### 🆕 다중 타임프레임(MTF) 설정
| 파라미터                  | 기본값 | 설명                          |
| ------------------------- | ------ | ----------------------------- |
| `MTF_ENABLED`             | True   | MTF 분석 활성화               |
| `MTF_5M_MIN_CANDLES`      | 24     | 5분봉 최소 필요 개수 (2시간)  |
| `MTF_15M_MIN_CANDLES`     | 12     | 15분봉 최소 필요 개수 (3시간) |
| `MTF_5M_TREND_THRESHOLD`  | 0.002  | 5분봉 상승 추세 기준 (0.2%)   |
| `MTF_15M_TREND_THRESHOLD` | 0.001  | 15분봉 추세 기준 (0.1%)       |
| `MTF_5M_EARLY_STAGE_MAX`  | 0.025  | 상승 초기 단계 최대치 (2.5%)  |
| `MTF_VOLUME_CONFIRMATION` | 1.5    | 5분봉 거래량 확인 배율        |
| `MTF_STRICT_MODE`         | True   | 15분봉 하락 시 무조건 차단    |

### 추세 분석 (Macro/Trend Analysis)
| 파라미터                  | 기본값 | 설명                          |
| ------------------------- | ------ | ----------------------------- |
| `MACRO_MIN_CHANGE_RATE`   | -0.015 | 하락장 컷오프 (-1.5%)         |
| `MACRO_BULLISH_THRESHOLD` | 0.015  | 상승장 기준 (+1.5%)           |
| `MACRO_UPDATE_INTERVAL`   | 300    | 추세 분석 업데이트 주기 (5분) |

### 단타 전문가 기법 (Pro Scalping)
| 파라미터                   | 기본값 | 설명                       |
| -------------------------- | ------ | -------------------------- |
| `SHORT_TREND_WINDOW`       | 20     | 초단기 윈도우 (20분)       |
| `SHORT_MOMENTUM_THRESHOLD` | 0.008  | 단기 수급 폭발 기준 (0.8%) |
| `VOL_INTENSITY_THRESHOLD`  | 2.5    | 수급 집중도 (2.5배)        |
| `BREAKOUT_VELOCITY`        | 0.0015 | 가격 가속도 (0.15%/분)     |

### 진입 모멘텀 (Entry Momentum)
| 파라미터                 | 기본값 | 설명                               |
| ------------------------ | ------ | ---------------------------------- |
| `MOMENTUM_WINDOW`        | 20     | 모멘텀 계산 윈도우 (20분)          |
| `MOMENTUM_THRESHOLD`     | 0.015  | 분봉 모멘텀 기준 (1.5%) - **상향** |
| `MIN_SIGNAL_STRENGTH`    | 75     | 진입 최소 강도 (75점) - **신규**   |
| `VOLUME_SPIKE_RATIO`     | 3.0    | 거래량 급등 배율 (3배)             |
| `CONSECUTIVE_UP_CANDLES` | 6      | 연속 상승 캔들 개수                |

### 🆕 청산 및 리스크 관리 (Exit & Risk) - v3.1 개선
| 파라미터                    | 기본값 | 설명                            |
| --------------------------- | ------ | ------------------------------- |
| `INITIAL_STOP_LOSS`         | 0.025  | 기본 손절선 (2.5%)              |
| `DYNAMIC_STOP_LOSS_ENABLED` | True   | 동적 손절선 활성화              |
| `DYNAMIC_STOP_LOSS_MIN`     | 0.018  | 동적 손절 최소 (1.8%)           |
| `DYNAMIC_STOP_LOSS_MAX`     | 0.035  | 동적 손절 최대 (3.5%)           |
| `TRAILING_STOP_ACTIVATION`  | 0.012  | 트레일링 활성화 (+1.2%)         |
| `TRAILING_STOP_DISTANCE`    | 0.008  | 추적 거리 (0.8%)                |
| `TRAILING_MIN_PROFIT`       | 0.005  | 🆕 최소 수익 보장 (0.5%)         |
| `TAKE_PROFIT_TARGET`        | 0.025  | 목표 수익률 (+2.5%)             |
| `MAX_HOLDING_TIME`          | 21600  | 시간 제한 (6시간)               |
| `COOL_DOWN_AFTER_LOSS`      | 600    | 손절 후 대기 (10분)             |
| `CONSECUTIVE_LOSS_COOLDOWN` | 1200   | 🆕 연속 손절 시 추가 대기 (20분) |
| `MAX_TRADES_PER_HOUR`       | 20     | 시간당 최대 거래 (20회)         |

### BTC 중심 시장 분석
| 파라미터                  | 기본값  | 설명                    |
| ------------------------- | ------- | ----------------------- |
| `BTC_MARKET`              | KRW-BTC | 비트코인 마켓           |
| `BTC_TREND_THRESHOLD`     | -0.005  | BTC 하락 임계값 (-0.5%) |
| `BTC_DOWNTREND_BUY_BLOCK` | False   | BTC 하락 시 매수 금지   |

### 시스템 설정
| 파라미터           | 기본값 | 설명                           |
| ------------------ | ------ | ------------------------------ |
| `MARKET`           | []     | 거래 대상 (빈 배열: 자동 선정) |
| `TOP_MARKET_COUNT` | 20     | 거래대금 상위 N개 자동 선정    |
| `DRY_RUN`          | True   | 테스트 모드 (True: 실거래 X)   |

---

## 📊 로그 해석

```
# 시작 시 표시
🚀 모멘텀 트레이딩 봇 시작 (BTC 중심 전략)
💰 KRW 잔고: 9,982,472원
🔌 Public WebSocket 연결됨 (20개 마켓) - 1분/5분/15분봉 + 체결 + 호가

# 30초마다 분석 상태 표시
💰 누적 수익: +15,000원 | 거래: 3회 (승:2/패:1) | 실행시간: 1:30:00
[KRW-BTC] 📊 150,000,000원 | 분봉:+0.35% | RSI:55 피로:12 | 매수:62% | 🟢bullish
[KRW-AXS] 📊     3,078원 | 분봉:+0.59% | RSI:50 피로:49 | 매수:21% | 🔴bearish

# MTF 차단 (고점 추격 방지)
[KRW-DKA] 🚫 MTF 차단: ⚠️ 상승 후반 (3.12%) - 고점 추격 위험

# 15분봉 하락 차단
[KRW-BERA] 🚫 MTF 차단: 🚫 15분봉 하락 (-0.45%)

# v3.1: 재진입 방지
[KRW-AXS] ⏳ 재진입 대기 - 현재가(3,200) > 재진입가(3,136)

# 진입 신호 확정 (MTF 통과)
[KRW-AXS] 🎯 진입 신호 확정!
   모멘텀(+1.2%) / 수급집중(3.2x) | 🎯 상승초기 진입
   강도:78.5 | 심리:bullish(72) | 매수:68%/매도:32%
   RSI:58.3 | 피로도:18.5 | 호가불균형:0.35
   📊 MTF: 🟢초기 | 5m:bullish 15m:bullish

# 매수 체결 (동적 손절선 표시)
🛒 시장가 매수 주문 | UUID: xxx | 금액: 1,000,000원
✅ 매수 체결 | 가격: 3,078원 | 손절가: 3,001원 (동적 2.5%)

# v3.1: 트레일링 활성화 시 최소 수익 보장 표시
📊 트레일링 스탑 활성화 | 수익률: +1.25% | 최소 수익 보장: 0.5%

# 보유 중 상태
📈 보유 중 | 수량: 325.01 | 매수가: 3,078원 | 현재가: 3,150원 | 수익률: +2.34% | 손절가: 3,093원

# 매도 완료 (최소 수익 보장됨)
🎉 매도 완료 | 사유: trailing_stop | 수익: +25,000원 (+2.50%) | 매도가: 3,155원
💰 누적 수익: +40,000원 | 총 4회 거래 (승:3/패:1)
```

---

## 📁 파일 구조

```
ubit_momentum/
├── momentum_trader.py   # 메인 트레이딩 봇 (자동매매)
├── run_trader.sh        # 트레이더 실행 스크립트
├── .env                 # API 키 설정
├── logs/                # 거래 로그 디렉토리
│   └── trades.csv       # 거래 내역 CSV
├── data/                # 캔들 데이터 캐시 (JSON)
├── api.md               # API 문서
└── README.md            # 이 파일
```

---

## 🔧 파라미터 튜닝 가이드

### 더 보수적으로 (손실 최소화 우선)
```python
MTF_5M_EARLY_STAGE_MAX = 0.015      # 1.5% 이하만 진입
MTF_15M_TREND_THRESHOLD = 0.002     # 15분봉 더 엄격하게
DYNAMIC_STOP_LOSS_MIN = 0.015       # 동적 손절 최소를 1.5%로
TRAILING_MIN_PROFIT = 0.008         # 최소 수익 보장을 0.8%로
COOL_DOWN_AFTER_LOSS = 900          # 손절 후 15분 대기
```

### 더 공격적으로 (진입 기회 증가)
```python
MTF_5M_EARLY_STAGE_MAX = 0.03       # 3%까지 허용
MTF_STRICT_MODE = False             # 15분봉 하락에도 진입 허용
MOMENTUM_THRESHOLD = 0.008          # 진입 조건 완화
DYNAMIC_STOP_LOSS_MAX = 0.04        # 동적 손절 최대를 4%로
TRAILING_STOP_ACTIVATION = 0.01     # 1%에서 트레일링 활성화
```

---

## ⚠️ 주의사항

1. **테스트 모드**: 기본값으로 `DRY_RUN = True`가 설정되어 있어 실제 거래가 수행되지 않습니다.

2. **실제 거래 시**: `DRY_RUN = False`로 변경 후 반드시 소액으로 테스트하세요.

3. **API 제한**: 업비트 API 요청 제한 (시세 조회: 초당 10회 / 주문: 초당 8회)

4. **수수료**: 거래 수수료 0.05%가 누적되므로 빈번한 거래 주의

5. **네트워크**: 안정적인 인터넷 환경에서 실행 권장

---

## 📝 라이선스

본 코드는 교육 및 연구 목적으로 제공됩니다.
실제 투자에 사용할 경우 발생하는 손실에 대해 책임지지 않습니다.
