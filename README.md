# 🚀 업비트 모멘텀 트레이딩 봇

"달리는 말에 올라타는" 전략을 구현한 자동 코인 트레이딩 봇입니다.

## 📋 전략 개요

### 핵심 철학
- **거시적 분석**: 일/주/월 캔들로 전체 시장 추세 파악 (하락장 관망)
- **미시적 분석**: 분봉 + **초봉**으로 실시간 모멘텀 감지
- **전문가 관점 분석**: RSI, 피로도, 매수/매도 세력 비율, 호가창 분석으로 종합 판단
- **빠른 진입**: 상승 모멘텀 감지 시 시장가로 즉시 매수
- **동적 청산**: 트레일링 스탑으로 수익 보호, 빠른 손절로 손실 최소화

### 🧠 전문가 관점 분석 시스템 (v2.0 신규)

단순한 가격 상승만 보고 진입하지 않고, 시장 심리와 수급을 종합적으로 분석합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 종합 시장 심리 분석 (실시간 WebSocket 기반)                   │
├─────────────────────────────────────────────────────────────────┤
│  1. RSI (상대강도지수)                                           │
│     ├── 70↑: 과매수 구간 → 진입 신중 / 80↑: 진입 차단           │
│     └── 30↓: 과매도 구간 → 반등 가능성 높음                      │
├─────────────────────────────────────────────────────────────────┤
│  2. 급등 피로도 (0-100)                                          │
│     ├── 5분간 급격한 상승률                                      │
│     ├── RSI 과매수 가중치                                        │
│     ├── 거래량 스파이크 후 급감 (모멘텀 소진)                    │
│     └── 매도 우위 전환 감지                                      │
│     → 40↑: 신중 접근 / 60↑: 조정 가능성 높음                    │
├─────────────────────────────────────────────────────────────────┤
│  3. 매수/매도 세력 분석                                          │
│     ├── 1분간 체결 데이터 실시간 집계                            │
│     ├── 매수체결(BID) vs 매도체결(ASK) 비율                      │
│     └── 65%↑ 매수: 강한 매수세 / 35%↓ 매수: 매도 압력            │
├─────────────────────────────────────────────────────────────────┤
│  4. 호가창 불균형 (-1 ~ +1)                                      │
│     ├── +0.3↑: 매수벽 우위 (지지력 강함)                        │
│     └── -0.3↓: 매도벽 우위 (저항 강함)                          │
├─────────────────────────────────────────────────────────────────┤
│  5. 변동성 분석                                                  │
│     └── 표준편차 기반 변동성이 2%↑이면 리스크 가중               │
└─────────────────────────────────────────────────────────────────┘
           ↓ 종합 점수 (0-100)
    🟢 Bullish (65↑)  🟡 Neutral (35-65)  🔴 Bearish (35↓)
```

### 다중 시간대 분석 (Multi-Timeframe Analysis) - 단타 전문가 기법

```
┌─────────────────────────────────────────────────────────────────┐
│  추세 분석 (5분마다 업데이트)                                    │
│  ├── 15분봉 (40%): 최근 15분 수급 흐름 (초단기 대응)            │
│  ├── 30분봉 (25%): 중단기 지지/저항 확인                        │
│  ├── 1시간/4시간 (30%): 매물대 및 추세 배경                     │
│  └── 일봉 (5%): 현재 위치 확인                                  │
│       → 🚀 단기 수급 폭발(15분 > 0.5%) 시 거시 하락장 무시       │
├─────────────────────────────────────────────────────────────────┤
│  미시 분석 (1초마다 업데이트)                                    │
│  ├── 가격 가속도(Velocity): 분당 0.1% 이상의 빠른 돌파 감지     │
│  ├── 수급 집중도(Intensity): 평균 대비 2배 이상의 거래량 집중   │
│  └── 초봉(1초): 최적의 진입 포인트 타격                         │
└─────────────────────────────────────────────────────────────────┘
```

### 진입 조건 (4단계 필터링)

```
1️⃣ 종합 심리 분석 → 부정적(bearish)이면 즉시 차단
2️⃣ 모멘텀 감지 → 분봉+초봉 결합 분석
3️⃣ 피로도/과매수 필터링 → 조건 강화 또는 차단
4️⃣ 모멘텀 소진 체크 → 거래량 급감 시 차단
```

| 단계  | 조건                    | 결과                               |
| ----- | ----------------------- | ---------------------------------- |
| 1단계 | 심리 점수 35점 미만     | ❌ 진입 차단                        |
| 2단계 | 모멘텀 신호 없음        | ❌ 대기                             |
| 3단계 | 피로도 40↑ 또는 RSI 70↑ | 강도 70↑ 필요 + 매도비율 55%↓ 필요 |
| 4단계 | 모멘텀 소진             | ❌ 진입 보류                        |
| 통과  | 모든 조건 충족          | ✅ 진입 확정                        |

### 청산 전략 (트레일링 스탑)

```
매수 후
    │
    ├── +0.3% 도달 → 트레일링 스탑 활성화 (손절선 상향 시작)
    │
    ├── +1.0% 도달 → 손절선을 매입가로 올림 (손실 없이 청산 보장!)
    │                    ↓
    │              계속 상승 추세 추적 (바로 익절하지 않음)
    │                    ↓
    └── 고점에서 -0.4% 하락 → 트레일링 스탑 발동 (익절)

손절: 매입가 대비 -0.5% 도달 시 즉시 매도
시간제한: 30분 보유 시 자동 청산
```

## 🛠 설치 및 실행

### 1. 환경 설정
```bash
# 가상환경 생성
python3 -m venv venv

# 가상환경 활성화
source venv/bin/activate

# 패키지 설치
pip install websockets aiohttp python-dotenv PyJWT requests
```

### 2. API 키 설정
`.env` 파일에 업비트 API 키가 설정되어 있어야 합니다:
```
UPBIT_ACCESS_KEY=your_access_key
UPBIT_SECRET_KEY=your_secret_key
```

### 3. 실행
```bash
# 방법 1: 직접 실행
./venv/bin/python momentum_trader.py

# 방법 2: 백그라운드 실행
nohup ./venv/bin/python momentum_trader.py > trading.log 2>&1 &

# 로그 실시간 확인
tail -f trading.log
```

## ⚙️ 파라미터 조정

`momentum_trader.py` 상단의 파라미터를 조정하여 전략을 커스터마이징할 수 있습니다:

### 투자 설정
| 파라미터           | 기본값    | 설명                |
| ------------------ | --------- | ------------------- |
| `MAX_INVESTMENT`   | 1,000,000 | 최대 투자금 (원)    |
| `MIN_ORDER_AMOUNT` | 5,100     | 최소 주문 금액      |
| `TRADING_FEE_RATE` | 0.0005    | 거래 수수료 (0.05%) |

### 1. 추세 분석 (Macro/Trend Analysis)
전체적인 시장의 분위기를 파악하여 거래 가능 여부를 결정합니다.

| 파라미터                  | 기본값 | 상세 설명                                                                      |
| ------------------------- | ------ | ------------------------------------------------------------------------------ |
| `MACRO_LOOKBACK_DAYS`     | 7      | 일봉 분석 시 참고할 과거 기간입니다.                                           |
| `MACRO_MIN_CHANGE_RATE`   | -0.02  | **하락장 컷오프**: 종합 점수가 -2% 이하일 경우 하락장으로 판단하고 관망합니다. |
| `MACRO_BULLISH_THRESHOLD` | 0.01   | **상승장 기준**: 종합 점수가 +1% 이상일 경우 적극적 매수 구간으로 판단합니다.  |
| `MACRO_UPDATE_INTERVAL`   | 300    | 추세 분석 업데이트 주기(5분)입니다.                                            |

### 2. 단타 전문가 기법 (Pro Scalping)
거시 지표가 좋지 않아도 단기적인 수급이 폭발하는 구간을 포착합니다.

| 파라미터                   | 기본값 | 상세 설명                                                                              |
| -------------------------- | ------ | -------------------------------------------------------------------------------------- |
| `SHORT_TREND_WINDOW`       | 15     | **초단기 윈도우**: 최근 15분간의 흐름을 집중 분석합니다.                               |
| `SHORT_MOMENTUM_THRESHOLD` | 0.005  | **단기 수급 폭발(0.5%)**: 15분 내 0.5% 반등 시 거시 지표를 무시하고 거래를 허용합니다. |
| `VOL_INTENSITY_THRESHOLD`  | 2.0    | **수급 집중도**: 최근 거래량이 이전 평균 대비 2배 이상일 때 진입 강도를 높입니다.      |
| `BREAKOUT_VELOCITY`        | 0.001  | **가격 가속도**: 분당 0.1% 이상의 속도로 가격이 치솟을 때 돌파 매매 신호로 간주합니다. |

### 3. 진입 모멘텀 (Entry Momentum)
분봉과 초봉을 결합하여 최적의 진입 시점을 결정합니다.

| 파라미터                      | 기본값 | 상세 설명                                                                 |
| ----------------------------- | ------ | ------------------------------------------------------------------------- |
| `MOMENTUM_THRESHOLD`          | 0.003  | **분봉 기준(0.3%)**: 최근 10분간 가격이 0.3% 이상 상승해야 합니다.        |
| `VOLUME_SPIKE_RATIO`          | 1.5    | **거래량 배율**: 최근 거래량이 10분 평균 대비 1.5배 이상이어야 합니다.    |
| `SECOND_MOMENTUM_THRESHOLD`   | 0.001  | **초봉 기준(0.1%)**: 최근 12초간 가격이 0.1% 이상 상승해야 합니다.        |
| `SECOND_RAPID_RISE_THRESHOLD` | 0.002  | **급등 감지(0.2%)**: 5초 내에 0.2% 이상 급등 시 '빠른 진입'을 시도합니다. |

### 4. 청산 및 리스크 관리 (Exit & Risk)
수익을 지키고 손실을 최소화하는 핵심 설정입니다.

| 파라미터                   | 기본값 | 상세 설명                                                                                        |
| -------------------------- | ------ | ------------------------------------------------------------------------------------------------ |
| `INITIAL_STOP_LOSS`        | 0.005  | **손절선(-0.5%)**: 매입가 대비 0.5% 하락 시 즉시 시장가 매도합니다.                              |
| `TRAILING_STOP_ACTIVATION` | 0.003  | **익절 준비(+0.3%)**: 수익률이 0.3%를 넘어서면 추적 수익 보존 모드로 들어갑니다.                 |
| `TAKE_PROFIT_TARGET`       | 0.01   | **목표 수익률(1%)**: 1% 도달 시 손절선을 매입가로 상향하여 원금을 보장하고 추가 상승을 노립니다. |
| `TRAILING_STOP_DISTANCE`   | 0.004  | **추적 거리(0.4%)**: 고점 대비 0.4% 하락 시 추세가 꺾인 것으로 보고 익절합니다.                  |
| `MAX_HOLDING_TIME`         | 1800   | **시간 제한(30분)**: 30분 동안 목표에 도달하지 못하면 기회비용 확보를 위해 청산합니다.           |
| `COOL_DOWN_AFTER_LOSS`     | 180    | **뇌동매매 방지**: 손절 발생 후 3분간은 추가 진입을 금지합니다.                                  |

### 5. 시스템 및 기타 설정
| 파라미터                  | 기본값  | 상세 설명                                                                |
| ------------------------- | ------- | ------------------------------------------------------------------------ |
| `MARKET`                  | KRW-BTC | 거래 대상 코인입니다.                                                    |
| `DRY_RUN`                 | True    | **실제 거래 여부**: True면 주문을 내지 않는 테스트 모드입니다.           |
| `MAX_TRADES_PER_HOUR`     | 10      | 과도한 거래 방지를 위한 시간당 최대 거래 횟수 제한입니다.                |
| `BALANCE_REPORT_INTERVAL` | 300     | **잔고 리포트 주기**: 5분마다 보유 종목과 잔고 현황을 로그로 출력합니다. |

## 📊 로그 해석

```
# 시작 시 표시
🚀 모멘텀 트레이딩 봇 시작 (BTC 중심 전략)
💰 KRW 잔고: 9,982,472원
� Public WebSocket 연결됨 (4개 마켓) - 1분/5분/15분봉 + 체결 + 호가

# 30초마다 분석 상태 표시 (심리 분석 포함)
� 누적 수익: +15,000원 | 거래: 3회 (승:2/패:1) | 실행시간: 1:30:00
[KRW-BTC] 📊 150,000,000원 | 분봉:+0.35% | RSI:55 피로:12 | 매수:62% | 🟢bullish
[KRW-ETH] 📊   4,500,000원 | 분봉:-0.12% | RSI:72 피로:45 | 매수:38% | 🟡neutral

# 진입 차단 (심리 분석에 의해)
[KRW-BTC] 🚫 진입 차단 - 부정적 심리 (점수:28)
   경고: 🚨 극심한 과매수 (RSI:82) | 🔥 급등 피로도 높음 (65) - 조정 가능성

# 신중 대기 (피로도/과매수)
[KRW-BTC] ⚠️ 신호 감지되었으나 피로도/과매수로 신중 대기 | 피로도:45 RSI:72 강도:55

# 진입 신호 확정 (모든 조건 통과)
[KRW-BTC] 🎯 진입 신호 확정!
   모멘텀(+1.2%) / 수급집중(3.2x) / 가속도↑(0.18%)
   강도:78.5 | 심리:bullish(72) | 매수:68%/매도:32%
   RSI:58.3 | 피로도:18.5 | 호가불균형:0.35

# 매수 체결
🛒 시장가 매수 주문 | UUID: xxx | 금액: 1,000,000원
✅ 매수 체결 | 가격: 150,000,000원 | 손절가: 147,000,000원

# 트레일링 스탑 활성화
📊 트레일링 스탑 활성화 | 수익률: +1.52%
🎯 목표 수익률 2.0% 도달! 트레일링 활성화 (손절가→매입가)

# 보유 중 상태
📈 보유 중 | 현재가: 153,000,000원 | 수익률: +2.00% | 손절가: 150,000,000원

# 모멘텀 소진 감지
[KRW-BTC] 📉 모멘텀 소진 - 거래량 급감으로 진입 보류

# 매도 완료
🎉 매도 완료 | 사유: trailing_stop | 수익: +25,000원 (+2.50%) | 매도가: 153,750,000원
💰 누적 수익: +40,000원 | 총 4회 거래 (승:3/패:1)
```

## ⚠️ 주의사항

1. **테스트 모드**: 기본값으로 `DRY_RUN = True`가 설정되어 있어 실제 거래가 수행되지 않습니다.

2. **실제 거래 시**: `DRY_RUN = False`로 변경 후 반드시 소액으로 테스트하세요.

3. **API 제한**: 업비트 API 요청 제한:
   - 시세 조회: 초당 10회
   - 주문 생성/취소: 초당 8회

4. **수수료**: 거래 수수료 0.05%가 누적되므로 빈번한 거래 주의

5. **네트워크**: 안정적인 환경에서 실행 권장

## 📝 테스트

```bash
# 최소 금액으로 매수/매도 테스트
./venv/bin/python test_order.py
```

## 📁 파일 구조

```
ubit_momentum/
├── momentum_trader.py   # 메인 트레이딩 봇 (자동매매)
├── run_trader.sh        # 트레이더 실행 스크립트
├── .env                 # API 키 설정
├── logs/               # 거래 로그 디렉토리
├── api.md              # API 문서
└── README.md           # 이 파일
```

## 📝 라이선스

본 코드는 교육 및 연구 목적으로 제공됩니다.
실제 투자에 사용할 경우 발생하는 손실에 대해 책임지지 않습니다.
